{% extends "base.html" %}

{% block content %}
<div class="row">
    <!-- 账户概览 -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">账户概览</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">账户总资产 (USDT)</h6>
                                <h3 class="card-title mb-0" id="totalBalance">--</h3>
                                <small class="text-muted">24h变化: <span id="balanceChange" class="text-success">--</span></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">可用余额 (USDT)</h6>
                                <h3 class="card-title mb-0" id="availableBalance">--</h3>
                                <small class="text-muted">冻结: <span id="frozenBalance">--</span></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">今日盈亏 (USDT)</h6>
                                <h3 class="card-title mb-0" id="todayProfit">--</h3>
                                <small class="text-muted">总盈亏: <span id="totalProfit">--</span></small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-subtitle mb-2 text-muted">持仓数量</h6>
                                <h3 class="card-title mb-0" id="positionCount">--</h3>
                                <small class="text-muted">订单数: <span id="orderCount">--</span></small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统状态 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">OctoBot 状态</h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    当前状态: <span class="badge bg-{{ 'success' if status == '运行中' else 'danger' }}">{{ status }}</span>
                </p>
                <form method="POST" action="{{ url_for('control') }}" class="d-flex gap-2">
                    <button type="submit" name="action" value="start" class="btn btn-success" {{ 'disabled' if status == '运行中' }}>
                        <i class="bi bi-play-fill"></i> 启动
                    </button>
                    <button type="submit" name="action" value="stop" class="btn btn-danger" {{ 'disabled' if status != '运行中' }}>
                        <i class="bi bi-stop-fill"></i> 停止
                    </button>
                    <button type="submit" name="action" value="restart" class="btn btn-warning" {{ 'disabled' if status != '运行中' }}>
                        <i class="bi bi-arrow-clockwise"></i> 重启
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 当前持仓 -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">当前持仓</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="positionsTable">
                        <thead>
                            <tr>
                                <th>交易对</th>
                                <th>持仓量</th>
                                <th>开仓均价</th>
                                <th>当前价格</th>
                                <th>未实现盈亏</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 持仓数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- 交易控制 -->
    <div class="col-md-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">交易控制</h5>
            </div>
            <div class="card-body">
                <form id="tradingControl" method="POST" action="{{ url_for('trading') }}" class="d-flex gap-2 mb-4">
                    <button type="submit" name="start_strategy" value="simulation" class="btn btn-warning">
                        <i class="bi bi-play-circle"></i> 启动模拟交易
                    </button>
                    <button type="submit" name="start_strategy" value="real" class="btn btn-danger" 
                            onclick="return confirm('确定要开始实盘交易吗？这将使用真实资金！')">
                        <i class="bi bi-play-circle-fill"></i> 启动实盘交易
                    </button>
                </form>

                <div class="row">
                    <div class="col-md-4 mb-3">
                        <a href="{{ url_for('trading') }}" class="btn btn-primary w-100">
                            <i class="bi bi-graph-up"></i> 交易管理
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{{ url_for('manual_trading') }}" class="btn btn-success w-100">
                            <i class="bi bi-currency-exchange"></i> 手动交易
                        </a>
                    </div>
                    <div class="col-md-4 mb-3">
                        <a href="{{ url_for('strategies') }}" class="btn btn-info w-100">
                            <i class="bi bi-gear"></i> 策略配置
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 系统信息 -->
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">系统信息</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>版本：</strong> OctoBot 2.0.8</p>
                        <p><strong>Web界面：</strong> <a href="http://localhost:5001" target="_blank">http://localhost:5001</a></p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>文档：</strong> <a href="https://www.octobot.cloud/en/guides/octobot" target="_blank">官方文档</a></p>
                        <p><strong>Github：</strong> <a href="https://github.com/Drakkar-Software/OctoBot" target="_blank">项目地址</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
// 格式化数字
function formatNumber(number, decimals = 2) {
    if (typeof number !== 'number') return '--';
    return number.toFixed(decimals);
}

// 格式化价格变化
function formatPriceChange(change) {
    if (typeof change !== 'number') return '--';
    const prefix = change > 0 ? '+' : '';
    return `${prefix}${change.toFixed(2)}%`;
}

// 自动更新状态和数据
async function updateDashboard() {
    try {
        // 更新系统状态
        const statusResponse = await fetch('/api/status');
        const statusData = await statusResponse.json();
        
        const statusBadge = document.querySelector('.badge');
        statusBadge.className = `badge bg-${statusData.status === '运行中' ? 'success' : 'danger'}`;
        statusBadge.textContent = statusData.status;
        
        // 更新按钮状态
        const startBtn = document.querySelector('button[value="start"]');
        const stopBtn = document.querySelector('button[value="stop"]');
        const restartBtn = document.querySelector('button[value="restart"]');
        
        if (startBtn && stopBtn && restartBtn) {
            startBtn.disabled = statusData.status === '运行中';
            stopBtn.disabled = statusData.status !== '运行中';
            restartBtn.disabled = statusData.status !== '运行中';
        }

        // 如果OctoBot未运行，显示提示并返回
        if (!statusData.running) {
            showAlert('OctoBot未运行，请先启动服务', 'warning');
            return;
        }

        // 更新账户信息
        const accountResponse = await fetch('/api/account');
        const data = await accountResponse.json();
        
        if (data.error) {
            throw new Error(data.error);
        }

        // 更新账户总览
        document.getElementById('totalBalance').textContent = formatNumber(data.total_balance);
        document.getElementById('availableBalance').textContent = formatNumber(data.available_balance);
        document.getElementById('todayProfit').textContent = formatNumber(data.today_profit);
        document.getElementById('totalProfit').textContent = formatNumber(data.total_profit);
        
        const balanceChangeElement = document.getElementById('balanceChange');
        balanceChangeElement.textContent = formatPriceChange(data.balance_change);
        balanceChangeElement.className = data.balance_change > 0 ? 'text-success' : 'text-danger';
        
        document.getElementById('frozenBalance').textContent = formatNumber(data.frozen_balance);
        document.getElementById('positionCount').textContent = data.position_count || '--';
        document.getElementById('orderCount').textContent = data.order_count || '--';

        // 更新持仓信息
        const tbody = document.querySelector('#positionsTable tbody');
        tbody.innerHTML = '';
        
        if (data.positions && data.positions.length > 0) {
            data.positions.forEach(position => {
                const row = document.createElement('tr');
                const profitClass = position.unrealized_pnl > 0 ? 'text-success' : 'text-danger';
                const profitPrefix = position.unrealized_pnl > 0 ? '+' : '';
                
                row.innerHTML = `
                    <td>${position.symbol}</td>
                    <td>${formatNumber(position.amount, 8)}</td>
                    <td>${formatNumber(position.entry_price, 2)}</td>
                    <td>${formatNumber(position.current_price, 2)}</td>
                    <td class="${profitClass}">${profitPrefix}${formatNumber(position.unrealized_pnl, 2)}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" 
                                onclick="closePosition('${position.symbol}')"
                                ${!statusData.running ? 'disabled' : ''}>
                            平仓
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        } else {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无持仓</td></tr>';
        }
    } catch (error) {
        console.error('更新数据失败:', error);
        showAlert(`更新数据失败: ${error.message}`, 'danger');
    }
}

// 平仓功能
async function closePosition(symbol) {
    if (!confirm(`确定要平掉 ${symbol} 的持仓吗？`)) {
        return;
    }
    
    try {
        const response = await fetch('/api/close_position', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ symbol: symbol })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert('平仓指令已发送', 'success');
            // 等待1秒后更新数据，给交易所API一些处理时间
            setTimeout(updateDashboard, 1000);
        } else {
            throw new Error(data.message || '平仓失败');
        }
    } catch (error) {
        console.error('平仓请求失败:', error);
        showAlert(error.message || '平仓请求失败', 'danger');
    }
}

// 页面加载完成后立即更新一次数据
document.addEventListener('DOMContentLoaded', updateDashboard);

// 每3秒更新一次数据
setInterval(updateDashboard, 3000);
</script>
{% endblock %}
{% endblock %} 