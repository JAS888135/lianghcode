{% extends "base.html" %}

{% block content %}
{% with messages = get_flashed_messages() %}
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}
{% endwith %}

<div class="container mt-4">
    <!-- 交易所配置 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">交易所配置</h5>
        </div>
        <div class="card-body">
            <form id="exchangeForm" method="POST">
                <div class="mb-3">
                    <label for="exchange" class="form-label">交易所</label>
                    <select class="form-select" id="exchange" name="exchange">
                        <option value="binance" {% if exchange_config and exchange_config.get('exchange') == 'binance' %}selected{% endif %}>Binance (币安)</option>
                        <option value="huobi" {% if exchange_config and exchange_config.get('exchange') == 'huobi' %}selected{% endif %}>Huobi (火币)</option>
                        <option value="okx" {% if exchange_config and exchange_config.get('exchange') == 'okx' %}selected{% endif %}>OKX</option>
                        <option value="bybit" {% if exchange_config and exchange_config.get('exchange') == 'bybit' %}selected{% endif %}>Bybit</option>
                        <option value="gate" {% if exchange_config and exchange_config.get('exchange') == 'gate' %}selected{% endif %}>Gate.io</option>
                        <option value="kucoin" {% if exchange_config and exchange_config.get('exchange') == 'kucoin' %}selected{% endif %}>KuCoin</option>
                        <option value="mexc" {% if exchange_config and exchange_config.get('exchange') == 'mexc' %}selected{% endif %}>MEXC</option>
                    </select>
                    <div class="form-text">选择要使用的交易所，不同交易所可能支持的交易对和功能有所不同</div>
                </div>
                <div class="mb-3">
                    <label for="trading_type" class="form-label">交易类型</label>
                    <select class="form-select" id="trading_type" name="trading_type">
                        <option value="spot" {% if exchange_config and exchange_config.get('trading_type') == 'spot' %}selected{% endif %}>现货交易</option>
                        <option value="futures" {% if exchange_config and exchange_config.get('trading_type') == 'futures' %}selected{% endif %}>合约交易</option>
                    </select>
                </div>
                <div id="leverageSection" class="mb-3" style="display: none;">
                    <label for="leverage" class="form-label">杠杆倍数</label>
                    <input type="number" class="form-control" id="leverage" name="leverage" 
                           value="{{ exchange_config.get('leverage', 1) }}"
                           min="1" max="100" step="1">
                    <div class="form-text">合约交易的杠杆倍数，范围: 1-100</div>
                </div>
                <div class="mb-3">
                    <label for="api_key" class="form-label">API Key</label>
                    <input type="text" class="form-control" id="api_key" name="api_key" value="{{ exchange_config.get('api_key', '') if exchange_config else '' }}" required>
                </div>
                <div class="mb-3">
                    <label for="secret_key" class="form-label">Secret Key</label>
                    <input type="password" class="form-control" id="secret_key" name="secret_key" value="{{ exchange_config.get('secret_key', '') if exchange_config else '' }}" required>
                </div>
                <button type="submit" name="save_exchange" class="btn btn-primary">保存配置</button>
            </form>
        </div>
    </div>

    <!-- 策略配置 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">策略配置</h5>
        </div>
        <div class="card-body">
            <form id="strategyForm" method="POST">
                <div class="mb-3">
                    <label for="trading_pair" class="form-label">交易对</label>
                    <select class="form-select" id="trading_pair" name="trading_pair" required>
                        <optgroup label="USDT 交易对">
                            <option value="BTC/USDT" {% if strategy_config and strategy_config.get('trading_pair') == 'BTC/USDT' %}selected{% endif %}>BTC/USDT (比特币)</option>
                            <option value="ETH/USDT" {% if strategy_config and strategy_config.get('trading_pair') == 'ETH/USDT' %}selected{% endif %}>ETH/USDT (以太坊)</option>
                            <option value="BNB/USDT" {% if strategy_config and strategy_config.get('trading_pair') == 'BNB/USDT' %}selected{% endif %}>BNB/USDT (币安币)</option>
                            <option value="SOL/USDT" {% if strategy_config and strategy_config.get('trading_pair') == 'SOL/USDT' %}selected{% endif %}>SOL/USDT (索拉纳)</option>
                            <option value="XRP/USDT" {% if strategy_config and strategy_config.get('trading_pair') == 'XRP/USDT' %}selected{% endif %}>XRP/USDT (瑞波币)</option>
                            <option value="ADA/USDT" {% if strategy_config and strategy_config.get('trading_pair') == 'ADA/USDT' %}selected{% endif %}>ADA/USDT (卡尔达诺)</option>
                            <option value="DOGE/USDT" {% if strategy_config and strategy_config.get('trading_pair') == 'DOGE/USDT' %}selected{% endif %}>DOGE/USDT (狗狗币)</option>
                        </optgroup>
                        <optgroup label="USDC 交易对">
                            <option value="BTC/USDC" {% if strategy_config and strategy_config.get('trading_pair') == 'BTC/USDC' %}selected{% endif %}>BTC/USDC</option>
                            <option value="ETH/USDC" {% if strategy_config and strategy_config.get('trading_pair') == 'ETH/USDC' %}selected{% endif %}>ETH/USDC</option>
                        </optgroup>
                        <optgroup label="其他交易对">
                            <option value="ETH/BTC" {% if strategy_config and strategy_config.get('trading_pair') == 'ETH/BTC' %}selected{% endif %}>ETH/BTC</option>
                            <option value="BNB/BTC" {% if strategy_config and strategy_config.get('trading_pair') == 'BNB/BTC' %}selected{% endif %}>BNB/BTC</option>
                        </optgroup>
                    </select>
                    <div class="form-text">选择要交易的币对，确保在所选交易所支持</div>
                    <div class="form-text mt-2">
                        <small class="text-muted">
                            如需自定义交易对，请直接在上方输入，格式为: 基础货币/计价货币 (例如: BTC/USDT)
                        </small>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="strategy_type" class="form-label">策略类型</label>
                    <select class="form-select" id="strategy_type" name="strategy_type" required>
                        <option value="dca" {% if strategy_config and strategy_config.get('strategy_type') == 'dca' %}selected{% endif %}>定投策略 (DCA)</option>
                        <option value="grid" {% if strategy_config and strategy_config.get('strategy_type') == 'grid' %}selected{% endif %}>网格策略</option>
                    </select>
                </div>

                <!-- DCA 策略参数 -->
                <div id="dcaParams" class="strategy-params" {% if strategy_config and strategy_config.get('strategy_type') == 'grid' %}style="display: none;"{% endif %}>
                    <div class="mb-3">
                        <label for="dca_interval" class="form-label">定投间隔 (小时)</label>
                        <input type="number" class="form-control" id="dca_interval" name="dca_interval" 
                               value="{{ strategy_config.get('dca', {}).get('interval', 24) if strategy_config else 24 }}"
                               min="1" max="168" required>
                        <div class="form-text">每隔多少小时执行一次定投，范围: 1-168小时</div>
                    </div>
                    <div class="mb-3">
                        <label for="dca_amount" class="form-label">每次投资金额</label>
                        <input type="number" class="form-control" id="dca_amount" name="dca_amount" 
                               value="{{ strategy_config.get('dca', {}).get('amount', 100) if strategy_config else 100 }}"
                               min="0.1" step="0.1" required>
                        <div class="form-text">每次定投的金额，最小 0.1</div>
                    </div>
                </div>

                <!-- 网格策略参数 -->
                <div id="gridParams" class="strategy-params" {% if not strategy_config or strategy_config.get('strategy_type') != 'grid' %}style="display: none;"{% endif %}>
                    <div class="mb-3">
                        <label for="grid_upper_price" class="form-label">上边界价格</label>
                        <input type="number" class="form-control" id="grid_upper_price" name="grid_upper_price" 
                               value="{{ strategy_config.get('grid', {}).get('upper_price', 50000) if strategy_config else 50000 }}"
                               min="0" step="0.000001" required>
                        <div class="form-text">网格策略的上边界价格</div>
                    </div>
                    <div class="mb-3">
                        <label for="grid_lower_price" class="form-label">下边界价格</label>
                        <input type="number" class="form-control" id="grid_lower_price" name="grid_lower_price" 
                               value="{{ strategy_config.get('grid', {}).get('lower_price', 40000) if strategy_config else 40000 }}"
                               min="0" step="0.000001" required>
                        <div class="form-text">网格策略的下边界价格</div>
                    </div>
                    <div class="mb-3">
                        <label for="grid_number" class="form-label">网格数量</label>
                        <input type="number" class="form-control" id="grid_number" name="grid_number" 
                               value="{{ strategy_config.get('grid', {}).get('grid_number', 10) if strategy_config else 10 }}"
                               min="3" max="50" required>
                        <div class="form-text">网格数量，范围: 3-50</div>
                    </div>
                    <div class="mb-3">
                        <label for="grid_total_investment" class="form-label">总投资金额</label>
                        <input type="number" class="form-control" id="grid_total_investment" name="grid_total_investment" 
                               value="{{ strategy_config.get('grid', {}).get('total_investment', 1000) if strategy_config else 1000 }}"
                               min="1" step="0.1" required>
                        <div class="form-text">网格策略的总投资金额，最小 1</div>
                    </div>
                </div>

                <!-- 风险控制参数 -->
                <div class="card mt-3">
                    <div class="card-header">
                        <h6 class="mb-0">风险控制</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="stop_loss" class="form-label">止损比例 (%)</label>
                            <input type="number" class="form-control" id="stop_loss" name="stop_loss" 
                                   value="{{ pair_risk_config.get('stop_loss', 5) if pair_risk_config else 5 }}"
                                   min="0.1" max="50" step="0.1" required>
                            <div class="form-text">触发止损的价格跌幅，范围: 0.1%-50%</div>
                        </div>
                        <div class="mb-3">
                            <label for="take_profit" class="form-label">止盈比例 (%)</label>
                            <input type="number" class="form-control" id="take_profit" name="take_profit" 
                                   value="{{ pair_risk_config.get('take_profit', 10) if pair_risk_config else 10 }}"
                                   min="0.1" max="1000" step="0.1" required>
                            <div class="form-text">触发止盈的价格涨幅，范围: 0.1%-1000%</div>
                        </div>
                        <div class="mb-3">
                            <label for="max_position" class="form-label">最大持仓量</label>
                            <input type="number" class="form-control" id="max_position" name="max_position" 
                                   value="{{ pair_risk_config.get('max_position', 1) if pair_risk_config else 1 }}"
                                   min="0.000001" step="0.000001" required>
                            <div class="form-text">单个交易对的最大持仓量（基础货币单位）</div>
                        </div>
                        <div class="mb-3">
                            <label for="max_trade_amount" class="form-label">单次最大交易额</label>
                            <input type="number" class="form-control" id="max_trade_amount" name="max_trade_amount" 
                                   value="{{ pair_risk_config.get('max_trade_amount', 1000) if pair_risk_config else 1000 }}"
                                   min="0.1" step="0.1" required>
                            <div class="form-text">单次交易的最大金额（计价货币单位）</div>
                        </div>
                    </div>
                </div>

                <button type="submit" name="save_strategy" class="btn btn-primary mt-3">保存策略</button>
            </form>
        </div>
    </div>

    <!-- 交易记录 -->
    <div class="card">
        <div class="card-header">
            <h5 class="mb-0">交易记录</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table" id="tradesTable">
                    <thead>
                        <tr>
                            <th>时间</th>
                            <th>交易对</th>
                            <th>方向</th>
                            <th>价格</th>
                            <th>数量</th>
                            <th>状态</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- 交易记录将通过 JavaScript 动态加载 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 交易所和交易对联动
    const exchangeSelect = document.getElementById('exchange');
    const tradingPairSelect = document.getElementById('trading_pair');
    const tradingTypeSelect = document.getElementById('trading_type');
    const leverageSection = document.getElementById('leverageSection');
    const leverageInput = document.getElementById('leverage');

    // 交易所配置
    const exchangeConfig = {
        'binance': {
            name: 'Binance',
            supportsSpot: true,
            supportsFutures: true,
            maxLeverage: 100,
            tradingPairs: ['USDT', 'USDC', 'BTC']
        },
        'huobi': {
            name: 'Huobi',
            supportsSpot: true,
            supportsFutures: true,
            maxLeverage: 100,
            tradingPairs: ['USDT', 'USDC']
        },
        'okx': {
            name: 'OKX',
            supportsSpot: true,
            supportsFutures: true,
            maxLeverage: 100,
            tradingPairs: ['USDT', 'USDC']
        },
        'bybit': {
            name: 'Bybit',
            supportsSpot: true,
            supportsFutures: true,
            maxLeverage: 100,
            tradingPairs: ['USDT', 'USDC']
        },
        'gate': {
            name: 'Gate.io',
            supportsSpot: true,
            supportsFutures: true,
            maxLeverage: 100,
            tradingPairs: ['USDT', 'USDC']
        },
        'kucoin': {
            name: 'KuCoin',
            supportsSpot: true,
            supportsFutures: true,
            maxLeverage: 100,
            tradingPairs: ['USDT', 'USDC']
        },
        'mexc': {
            name: 'MEXC',
            supportsSpot: true,
            supportsFutures: true,
            maxLeverage: 100,
            tradingPairs: ['USDT']
        }
    };

    // 交易对配置
    const tradingPairs = {
        'USDT': [
            { value: 'BTC/USDT', label: 'BTC/USDT (比特币)' },
            { value: 'ETH/USDT', label: 'ETH/USDT (以太坊)' },
            { value: 'BNB/USDT', label: 'BNB/USDT (币安币)' },
            { value: 'SOL/USDT', label: 'SOL/USDT (索拉纳)' },
            { value: 'XRP/USDT', label: 'XRP/USDT (瑞波币)' },
            { value: 'ADA/USDT', label: 'ADA/USDT (卡尔达诺)' },
            { value: 'DOGE/USDT', label: 'DOGE/USDT (狗狗币)' }
        ],
        'USDC': [
            { value: 'BTC/USDC', label: 'BTC/USDC' },
            { value: 'ETH/USDC', label: 'ETH/USDC' }
        ],
        'BTC': [
            { value: 'ETH/BTC', label: 'ETH/BTC' },
            { value: 'BNB/BTC', label: 'BNB/BTC' }
        ]
    };

    // 更新交易对选项
    function updateTradingPairs() {
        const exchange = exchangeSelect.value;
        const exchangeInfo = exchangeConfig[exchange];
        const currentPair = tradingPairSelect.value;
        
        // 清空现有选项
        tradingPairSelect.innerHTML = '';
        
        // 添加新的交易对选项
        exchangeInfo.tradingPairs.forEach(quoteCurrency => {
            if (tradingPairs[quoteCurrency]) {
                const optgroup = document.createElement('optgroup');
                optgroup.label = `${quoteCurrency} 交易对`;
                
                tradingPairs[quoteCurrency].forEach(pair => {
                    const option = document.createElement('option');
                    option.value = pair.value;
                    option.text = pair.label;
                    option.selected = pair.value === currentPair;
                    optgroup.appendChild(option);
                });
                
                tradingPairSelect.appendChild(optgroup);
            }
        });
    }

    // 更新交易类型选项
    function updateTradingType() {
        const exchange = exchangeSelect.value;
        const exchangeInfo = exchangeConfig[exchange];
        const currentType = tradingTypeSelect.value;
        
        // 禁用/启用期货选项
        const futuresOption = tradingTypeSelect.querySelector('option[value="futures"]');
        futuresOption.disabled = !exchangeInfo.supportsFutures;
        
        // 如果当前选择的是期货，但交易所不支持，则切换到现货
        if (currentType === 'futures' && !exchangeInfo.supportsFutures) {
            tradingTypeSelect.value = 'spot';
            leverageSection.style.display = 'none';
            leverageInput.required = false;
        }
        
        // 更新杠杆输入的最大值
        leverageInput.max = exchangeInfo.maxLeverage;
        leverageInput.title = `最大杠杆倍数: ${exchangeInfo.maxLeverage}`;
    }

    // 交易所变更事件
    exchangeSelect.addEventListener('change', function() {
        updateTradingPairs();
        updateTradingType();
    });

    // 交易类型变更事件
    tradingTypeSelect.addEventListener('change', function() {
        leverageSection.style.display = this.value === 'futures' ? 'block' : 'none';
        leverageInput.required = this.value === 'futures';
    });

    // 初始化
    updateTradingPairs();
    updateTradingType();
    leverageSection.style.display = tradingTypeSelect.value === 'futures' ? 'block' : 'none';
    leverageInput.required = tradingTypeSelect.value === 'futures';

    // 策略类型切换
    const strategyType = document.getElementById('strategy_type');
    const dcaParams = document.getElementById('dcaParams');
    const gridParams = document.getElementById('gridParams');

    function updateStrategyParams() {
        if (strategyType.value === 'dca') {
            dcaParams.style.display = 'block';
            gridParams.style.display = 'none';
            dcaParams.querySelectorAll('input').forEach(input => input.required = true);
            gridParams.querySelectorAll('input').forEach(input => input.required = false);
        } else if (strategyType.value === 'grid') {
            dcaParams.style.display = 'none';
            gridParams.style.display = 'block';
            dcaParams.querySelectorAll('input').forEach(input => input.required = false);
            gridParams.querySelectorAll('input').forEach(input => input.required = true);
        }
    }

    strategyType.addEventListener('change', updateStrategyParams);
    updateStrategyParams();

    // 加载交易记录
    function loadTrades() {
        fetch('/api/trades')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                const tbody = document.querySelector('#tradesTable tbody');
                tbody.innerHTML = '';
                
                if (data.trades && Array.isArray(data.trades)) {
                    data.trades.forEach(trade => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${new Date(trade.time).toLocaleString()}</td>
                            <td>${trade.pair || ''}</td>
                            <td>${trade.side || ''}</td>
                            <td>${trade.price || ''}</td>
                            <td>${trade.amount || ''}</td>
                            <td>${trade.status || ''}</td>
                        `;
                        tbody.appendChild(row);
                    });
                }

                if (!data.trades || data.trades.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无交易记录</td></tr>';
                }
            })
            .catch(error => {
                console.error('Error loading trades:', error);
                const tbody = document.querySelector('#tradesTable tbody');
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">加载交易记录失败</td></tr>';
            });
    }

    // 每30秒刷新一次交易记录
    loadTrades();
    setInterval(loadTrades, 30000);
});
</script>
{% endblock %} 